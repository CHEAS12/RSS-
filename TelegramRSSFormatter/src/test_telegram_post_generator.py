#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ –¥–ª—è Telegram —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI API
"""

import os
import sys
import logging
from typing import Dict, Any

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ src –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.append(os.path.join(os.path.dirname(__file__)))

from rss_formatter import RSSFormatter, RSSPost

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)

def create_test_news_item() -> RSSPost:
    """
    –°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ—Å—Ç–æ–≤.
    """
    return RSSPost(
        title="–ü—Ä–æ—Ä—ã–≤ –≤ –æ–±–ª–∞—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞: –Ω–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–∏—Ç GPT-4",
        author="–î–º–∏—Ç—Ä–∏–π –ò–≤–∞–Ω–æ–≤",
        summary="""–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ –°—Ç—ç–Ω—Ñ–æ—Ä–¥—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∏ —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—É—é 
        –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ 30% –ª—É—á—à–µ GPT-4 
        –≤ –∑–∞–¥–∞—á–∞—Ö –ø–æ–Ω–∏–º–∞–Ω–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ 
        –∏–Ω–æ–π –ø–æ–¥—Ö–æ–¥ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –¥–ª–∏–Ω–æ–π –¥–æ 2 
        –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω—å—à–∏—Ö –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç–∞—Ö. 

        –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
        ‚Ä¢ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        ‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç –Ω–∞ 40%
        ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        ‚Ä¢ –û—Ç–∫—Ä—ã—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞

        –ê–≤—Ç–æ—Ä—ã –ø–ª–∞–Ω–∏—Ä—É—é—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ –∂—É—Ä–Ω–∞–ª–µ 
        Nature Machine Intelligence –≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ.""",
        link="https://example-news.com/ai-breakthrough-2024",
        feed_title="TechNews Daily",
        content="""–í –º–∏—Ä–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –ø—Ä–æ–∏–∑–æ—à–µ–ª –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ä—ã–≤. 
        –ö–æ–º–∞–Ω–¥–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–¥ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ –ê–ª–µ–∫—Å–∏—Å–∞ –ö–æ–Ω–Ω–æ–ª–ª–∏ –∏–∑ 
        –°—Ç—ç–Ω—Ñ–æ—Ä–¥—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞, 
        –ø–æ–ª—É—á–∏–≤—à—É—é –Ω–∞–∑–≤–∞–Ω–∏–µ 'Quantum-Attention Transformer' (QAT).

        –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑–∞–ª–∏, —á—Ç–æ QAT –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–∏—Ç GPT-4 –Ω–∞:
        - 31% –≤ –∑–∞–¥–∞—á–∞—Ö —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
        - 28% –≤ –∑–∞–¥–∞—á–∞—Ö –ø–µ—Ä–µ–≤–æ–¥–∞
        - 35% –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è—Ö
        - 42% –≤ –∑–∞–¥–∞—á–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è

        –û—Å–æ–±–µ–Ω–Ω–æ –≤–ø–µ—á–∞—Ç–ª—è–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏. 
        –ï—Å–ª–∏ GPT-4 —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ 128k —Ç–æ–∫–µ–Ω–æ–≤, —Ç–æ QAT –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å 
        —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ –¥–æ 2M —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞.

        '–ú—ã —Å–º–æ–≥–ª–∏ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã 
        attention, –ø—Ä–∏–º–µ–Ω–∏–≤ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∫ –º–µ—Ö–∞–Ω–∏–∑–º—É –≤–Ω–∏–º–∞–Ω–∏—è', - 
        –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ö–æ–Ω–Ω–æ–ª–ª–∏.

        –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –º–æ–¥–µ–ª–∏ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT –¥–ª—è —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è 
        –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –≤ –æ–±–ª–∞—Å—Ç–∏ –ò–ò.""",
        media_attachments=[
            {
                "url": "https://example-news.com/images/ai-breakthrough.jpg",
                "type": "image/jpeg"
            }
        ]
    )

def test_ai_post_generation():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é generate_telegram_post() —Å –ø—Ä–∏–º–µ—Ä–æ–º –Ω–æ–≤–æ—Å—Ç–∏.
    """
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ –¥–ª—è Telegram")

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
        api_key = os.environ.get("OPENAI_API_KEY")
        if not api_key:
            logger.error("‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
            logger.info("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–ª—é—á: export OPENAI_API_KEY='your-key-here'")
            return

        logger.info(f"‚úÖ OpenAI API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω (–¥–ª–∏–Ω–∞: {len(api_key)} —Å–∏–º–≤–æ–ª–æ–≤)")

        # –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä —Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
        formatter = RSSFormatter(
            openai_api_key=api_key,
            enable_emojis=True,
            ai_enhance=True,
            length_limit=1024,
            enable_link_preview=True,
            enable_media=True
        )

        logger.info("‚úÖ RSSFormatter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")

        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–æ–≤–æ—Å—Ç–∏
        test_news = create_test_news_item()
        logger.info(f"‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞: '{test_news.title[:50]}...'")

        print("\n" + "="*80)
        print("üì∞ –¢–ï–°–¢–û–í–ê–Ø –ù–û–í–û–°–¢–¨ (–í–•–û–î)")
        print("="*80)
        print(f"üìå –ó–ê–ì–û–õ–û–í–û–ö: {test_news.title}")
        print(f"‚úçÔ∏è –ê–í–¢–û–†: {test_news.author}")
        print(f"üì° –ò–°–¢–û–ß–ù–ò–ö: {test_news.feed_title}")
        print(f"üîó –°–°–´–õ–ö–ê: {test_news.link}")
        print(f"üìù –ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï: {test_news.summary[:200]}...")
        print(f"üñºÔ∏è –ú–ï–î–ò–ê: {len(test_news.media_attachments)} –≤–ª–æ–∂–µ–Ω–∏–π")

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç —Å –ø–æ–º–æ—â—å—é AI
        logger.info("ü§ñ –ó–∞–ø—É—Å–∫ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞...")
        generated_post = formatter.generate_telegram_post(test_news)

        print("\n" + "="*80)
        print("ü§ñ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –ü–û–°–¢ –î–õ–Ø TELEGRAM (–í–´–•–û–î)")
        print("="*80)
        print(generated_post["text"])

        print("\n" + "-"*80)
        print("üìä –ú–ï–¢–ê–î–ê–ù–ù–´–ï –ü–û–°–¢–ê")
        print("-"*80)
        print(f"üìè –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(generated_post['text'])} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üñºÔ∏è –ú–µ–¥–∏–∞ –≤–ª–æ–∂–µ–Ω–∏–π: {len(generated_post.get('media', []))}")
        print(f"üîó –ü—Ä–µ–≤—å—é —Å—Å—ã–ª–∫–∏: {'–î–∞' if generated_post.get('link_preview') else '–ù–µ—Ç'}")

        if generated_post.get('media'):
            print("\nüìé –ú–ï–î–ò–ê –í–õ–û–ñ–ï–ù–ò–Ø:")
            for i, media in enumerate(generated_post['media'], 1):
                print(f"  {i}. {media.get('type', 'unknown')} - {media.get('url', 'no url')}")

        print("\n" + "="*80)
        print("‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!")
        print("="*80)

        logger.info("üéâ –¢–µ—Å—Ç AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        return generated_post

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        print(f"\n‚ùå –û–®–ò–ë–ö–ê: {e}")
        return None

def test_fallback_formatting():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ AI (fallback —Ä–µ–∂–∏–º).
    """
    logger.info("üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –±–∞–∑–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–±–µ–∑ AI)")

    try:
        # –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –ë–ï–ó AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        formatter = RSSFormatter(
            openai_api_key="fake-key",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–ª—å—à–∏–≤—ã–π –∫–ª—é—á –¥–ª—è —Ç–µ—Å—Ç–∞
            ai_enhance=False,  # –û—Ç–∫–ª—é—á–∞–µ–º AI
            enable_emojis=True,
            length_limit=1024
        )

        test_news = create_test_news_item()
        formatted_post = formatter.format_post(test_news)

        print("\n" + "="*80)
        print("üìù –ë–ê–ó–û–í–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï (–ë–ï–ó AI)")
        print("="*80)
        print(formatted_post["text"])
        print(f"\nüìè –î–ª–∏–Ω–∞: {len(formatted_post['text'])} —Å–∏–º–≤–æ–ª–æ–≤")

        logger.info("‚úÖ –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–µ–Ω")
        return formatted_post

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –±–∞–∑–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        return None

def compare_formats():
    """
    –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å –±–∞–∑–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
    """
    print("\n" + "="*80)
    print("‚öñÔ∏è –°–†–ê–í–ù–ï–ù–ò–ï –ú–ï–¢–û–î–û–í –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø")
    print("="*80)

    # –¢–µ—Å—Ç —Å AI
    ai_result = test_ai_post_generation()

    print("\n" + "-"*40)

    # –¢–µ—Å—Ç –±–µ–∑ AI
    fallback_result = test_fallback_formatting()

    if ai_result and fallback_result:
        print("\nüìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–†–ê–í–ù–ï–ù–ò–Ø:")
        print(f"  AI –ø–æ—Å—Ç: {len(ai_result['text'])} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"  –ë–∞–∑–æ–≤—ã–π –ø–æ—Å—Ç: {len(fallback_result['text'])} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"  –†–∞–∑–Ω–∏—Ü–∞: {len(ai_result['text']) - len(fallback_result['text'])} —Å–∏–º–≤–æ–ª–æ–≤")

if __name__ == "__main__":
    print("üéØ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ì–ï–ù–ï–†–ê–¶–ò–ò –ü–û–°–¢–û–í –î–õ–Ø TELEGRAM")
    print("" + "="*80)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    current_dir = os.path.dirname(os.path.abspath(__file__))
    logger.info(f"üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {current_dir}")

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç
    compare_formats()